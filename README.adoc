ifdef::env-github[]
:tip-caption: :bulb:
:note-caption: :information_source:
:important-caption: :heavy_exclamation_mark:
:caution-caption: :fire:
:warning-caption: :warning:
endif::[]

= **Openshift on Proxmox**
====================
:imagesdir: img

== Prerequisites

Before you start, Download and install Proxmox from : https://www.proxmox.com/en/downloads/category/iso-images-pve

image::Proxmox.png[500,500]

Installation process can be found on youtube : https://www.youtube.com/watch?v=7OVaWaqO2aU

The installation is easy, Flash the downloaded iso on a thumb drive and use it to boot your server from USB and the follow the prompt. you need to setup your storage after installation of Proxmox

== **Create your infra VM**

We need to create a VM that will contain external Dependencys for OCP installation. This box would act as: 

**Haproxy** : External load balancer for OCP masters

**Apache Webserver** : To host RHCOS images for OCP installation 

**PXE** : For PXE booting our OCP nodes

image::infra.png[100,100]

You can install CentOS stream 8 or RHEL 8 as the OS.

download Centos from :
https://www.centos.org/download/

Upload the downloaded iso to a storage on proxmox: 

image::CreateVM0.png[500,500]

Click on "Create VM" at the top right of proxmox UI and follow the following steps.


image::CreateVM2.png[500,500]

image::CreateVM3.png[500,500]

Select the Storage you want to store your VM storage and set the value to 30 GiB.

image::CreateVM4.png[500,500]

image::CreateVM5.png[500,500]

image::CreateVM6.png[500,500]


=== **Installing ansible and git **

To clone this repo and execute the script you need to install these two packages :

for centos follow these steps: 

```
   sudo dnf makecache
   sudo dnf install epel-release
   sudo dnf makecache
   yum -y install ansible git
```

== **Prep Infra/Helper Box**

  Clone this repo to the VM you just created above
```
  git clone https://github.com/Keyvan-rh/Proxmox-OCP-Installer.git
  cd Proxmox-OCP-Installer
  cd proxmox
```
  In this folder there are multiple yaml files for:

     CreateCluster.yml: for creating your OCP cluster 

     DleeteCluster.yml: for removing and cleaning OCP cluster from your Proxmox

     nfs-setup.yml: if you wish to use nfs as your storage provider of OCP ( you need to have a nfs server ready to use this).

     vars.yml: variables to be used for your OCP intstallation

=== **Customization and Preparation**

   There are couple places that you need to add your local and personal information before you can run the installer.

=== **proxmox/vars.yml**

   Before we start installing OCP cluster we need to update this file. You need the folowing information: 
       IP address of your proxmox server, the name of your Proxmox server (default is pve), and the local domain you need to use for OCP installation.if you would like you can change the clusterID as well this is usefull if you are planning to have multiple OCP cluster installed. 

```
      proxmox:
         ip: <IP address of your proxmox server>
         name: 'pve'
      clusterID: ocp4
      domain: < you domain : example.lab >
```
   Script will use this data to build your VMs and setup your infra/helper machine. pay attention to the Mac address and the IP addresses assiged to each machine if these are used in your end you can modified the values try to update the macstart and leave the rest as this would help you identify machines easier.

=== **templates/install-config.yml**

   In this file you need to add your continer registery Pull secret 

```
   pullSecret: < Add your Pull secret from cloud.redhat.com > 
   sshkey: < Add your ssh key >

```

image::PullSecret1.png[500,500]
image::PullSecret2.png[500,500]
image::PullSecret3.png[500,500]
image::PullSecret4.png[500,500]
image::PullSecret5.png[500,500]

   Now you need to create you own ssh key and add the public key to this file.

```
   ssh-keygen -t rsa -b 4096 -N ''
```
   Add your pub key to the authorized_keys on the proxmox box so the user that would run the ansible playbook can ssh to box with no password.
=== **Setup Ansible user **

=== **Setup Infra/Helper box**
   Now is time to install pakages, open ports, setup PXE boot and ...
   execute the following command in Proxmox-OCP-Installer/proxmox

```
   ansible-playbook CreateCluster.yml --tags build_infra 
```

=== ** Validate the infra/Helper box
   lets validate that all the parts are installed and startup: Haproxy: Using oyur browser go to the following link

```
   http://<ifra IP address>:9000/
```
image::lb_validate.png[500,500]

```
   http://<ifra IP address>:8080
```
image::apache.png[500,500]



== ** Install Openshift 4.x **

   First we need to get the correct version of openshift installer and the RHCOS, to do that we need to execute the following command: 
```
   ansible-playbook CreateCluster.yml --tags prep_install
```
=== ** Validate preperation step  **

```
   http://<ifra IP address>:8080/install
```
image::rhcos.png[500,500]

```
   http://<ifra IP address>:8080/ignition
```
image::ignition.png[500,500]

Check if all auto pxe config files has been generated:

```
ls /var/lib/tftpboot/pxelinux.cfg
```
image::pxe.png[500,500]

=== ** installing OCP CLuster  **

   Now that we have the everything we need we can install the cluster:
```
   ansible-playbook CreateCluster.yml --tags install_ocp
```  

   This will take 40 to 50 minutes so go get to coffee and do other work that you push back till we setup your OCP cluster.
=== ** Post Installation steps **

